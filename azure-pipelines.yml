parameters:
  - name: environment
    displayName: Target Environment
    type: string
    default: 'production'
    values:
      - development
      - staging
      - production

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  artifactoryService: 'hts2-npm2'
  targetRepo: 'manu-npm-local'
  # Added a default for this variable used in your promotion task
  promotionStatus: 'Released' 

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '25.6.1'
  displayName: 'Install Node.js'

- task: JFrogToolsInstaller@1
  inputs:
    artifactoryConnection: 'hts2-npm'
    cliInstallationRepo: 'jfrog-cli-v2-new'
    installCustomVersion: true
    cliVersion: '2.91.0'

# 1. Standard Bash for shell operations (mkdir)
- script: |
    mkdir -p $(HOME)/.npm/_cacache
  displayName: 'Initialize npm cache'

# 2. Consolidated JFrog Task
- task: JfrogCliV2@1
  inputs:
    jfrogPlatformConnection: $(artifactoryService)
    command: |
      jf npm-config --repo-resolve=$(targetRepo) --repo-deploy=$(targetRepo)
      jf npm install --build-name=$(Build.DefinitionName) --build-number=$(Build.BuildNumber)
      jf npm publish --build-name=$(Build.DefinitionName) --build-number=$(Build.BuildNumber)
      jf rt build-publish $(Build.DefinitionName) $(Build.BuildNumber)
  displayName: 'JFrog CLI: Config, Install, and Publish'

# 3. Build Promotion
- task: JFrogBuildPromotion@1
  inputs:
    artifactoryConnection: 'hts2-npm'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    projectKey: 'npm-test'
    targetRepo: 'manu-npm-local'
    status: '$(promotionStatus)'
    sourceRepo: 'manu-npm-release'
    includeDependencies: false
    copy: false
    dryRun: false
    # Parameters must be referenced with ${{ parameters.NAME }}
    comment: 'Promoted to ${{ parameters.environment }} by $(Build.RequestedFor) - Build $(Build.BuildNumber)'
  displayName: 'Promote Build to Artifactory'